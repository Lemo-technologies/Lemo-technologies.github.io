<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>LEMO-TUTOR Â· Rustenburg</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --bg: #05070a;
      --glass: rgba(15,20,25,0.96);
      --border: rgba(255,255,255,0.09);
      --text: #f0f2f5;
      --accent: #00ff88;
      --cursor: #00ffaa;
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body, html { height:100%; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow:hidden; }
    .screen { position:absolute; inset:0; display:none; flex-direction:column; }
    .screen.active { display:flex; }

    header {
      flex-shrink:0;
      padding:1rem 1.5rem;
      background:rgba(5,7,10,0.92);
      backdrop-filter:blur(20px);
      border-bottom:1px solid var(--border);
      display:flex;
      align-items:center;
      justify-content:space-between;
      height:64px;
    }
    .logo {
      font-size:1.2rem;
      font-weight:700;
      letter-spacing:3px;
      color:var(--accent);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .glow { width:9px; height:9px; background:var(--accent); border-radius:50%; box-shadow:0 0 14px var(--accent); }

    .main-content { flex:1; display:flex; overflow:hidden; }
    .content-area { flex:1; overflow-y:auto; padding:20px; background:var(--bg); -webkit-overflow-scrolling:touch; }

    /* â”€â”€â”€ AUTH / SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #auth-screen, #setup-screen {
      background: linear-gradient(135deg, #0a0e14, #05070a);
      align-items:center; justify-content:center;
    }
    .card {
      width:92%; max-width:420px;
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:24px;
      padding:40px 28px;
      box-shadow:0 30px 80px rgba(0,0,0,0.6);
      text-align:center;
    }
    input {
      width:100%; padding:15px 18px;
      background:#0a0e14; border:1px solid var(--border);
      border-radius:12px; color:white; margin:12px 0;
      font-size:1rem;
    }
    .btn {
      width:100%; padding:15px;
      background:var(--accent); color:#000;
      border:none; border-radius:12px;
      font-weight:700; font-size:1.05rem;
      cursor:pointer; margin-top:12px;
    }

    /* â”€â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-view { flex-direction:column; }
    #chat-container {
      flex:1; overflow-y:auto; padding:20px;
      display:flex; flex-direction:column; gap:18px;
    }
    .message {
      max-width:86%; padding:14px 20px;
      border-radius:18px; line-height:1.58; font-size:0.96rem;
      animation: pop 0.22s ease;
    }
    .user-msg {
      align-self:flex-end;
      background: linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,255,136,0.02));
      border:1px solid rgba(0,255,136,0.4);
      border-bottom-right-radius:5px;
    }
    .ai-msg {
      align-self:flex-start;
      background:var(--glass);
      border:1px solid var(--border);
      border-bottom-left-radius:5px;
      box-shadow:0 8px 24px rgba(0,0,0,0.3);
    }
    .input-area {
      padding:16px 20px;
      background: linear-gradient(to top, var(--bg) 70%, transparent);
      flex-shrink:0;
    }
    .input-card {
      background:#11151b; border:1px solid var(--border);
      border-radius:22px; padding:8px 16px;
      display:flex; align-items:center; gap:12px;
    }
    input[type=text] {
      flex:1; background:transparent; border:none;
      color:white; font-size:1rem; outline:none;
    }
    .send {
      background:var(--accent); color:#000;
      border:none; width:48px; height:48px;
      border-radius:16px; font-size:1.4rem;
      cursor:pointer;
    }
    .typing-cursor {
      display:inline-block; width:6px; height:1.25em;
      background:var(--cursor); margin-left:5px;
      border-radius:2px; vertical-align:middle;
      animation:blink 1.1s infinite;
    }
    @keyframes blink { 0%,100% {opacity:1} 50% {opacity:0.25} }
    @keyframes pop { from {opacity:0; transform:translateY(10px)} to {opacity:1; transform:none} }

    /* â”€â”€â”€ LIBRARY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .library-grid {
      display:grid; grid-template-columns:repeat(auto-fill, minmax(200px,1fr));
      gap:18px; margin-top:24px;
    }
    .res-card {
      background:var(--card); border:1px solid var(--border);
      border-radius:18px; overflow:hidden;
    }
    .pdf-preview {
      height:150px; background:linear-gradient(135deg,#1a2330,#0f141a);
      display:flex; align-items:center; justify-content:center;
      font-size:4rem; color:var(--accent);
    }
    .card-body { padding:14px; }
    .card-btns { display:flex; gap:10px; margin-top:10px; }
    .card-btn {
      flex:1; padding:9px; border-radius:10px;
      font-size:0.88rem; font-weight:600; cursor:pointer;
    }

    h2,h3 { color:var(--accent); margin:1.2em 0 0.5em; }
    pre { background:#0a0e14; padding:14px; border-radius:10px; overflow-x:auto; font-family:'JetBrains Mono',monospace; margin:1em 0; }
  </style>
</head>
<body>

<!-- â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="auth-screen" class="screen active">
  <div class="card">
    <div class="logo" style="justify-content:center; font-size:2rem; margin-bottom:20px;">
      <span style="font-size:2.6rem;">ðŸ§ </span> LEMO
    </div>
    <h2 id="auth-title">Welcome back</h2>
    <p style="opacity:0.7; margin:16px 0 24px;">Sign in to continue</p>
    <input type="email" id="email" placeholder="Email" />
    <input type="password" id="password" placeholder="Password" />
    <button class="btn" onclick="handleAuth()">Sign In</button>
    <p id="toggle-auth" style="margin-top:24px; color:var(--accent); cursor:pointer;" onclick="toggleAuth()">
      Don't have an account? Sign up
    </p>
  </div>
</div>

<!-- â”€â”€â”€ SETUP SUPABASE (only first time) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="setup-screen" class="screen">
  <div class="card">
    <h2>Supabase Setup</h2>
    <p style="opacity:0.75; margin:16px 0 24px;">One-time setup â€” stays in your browser</p>
    <input type="text" id="supa-url" placeholder="https://your-project.supabase.co" />
    <input type="text" id="supa-anon" placeholder="eyJhbGciOiJIUzI1NiIs..." />
    <button class="btn" onclick="saveSupabase()">Save & Continue</button>
  </div>
</div>

<!-- â”€â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="main-app" class="screen">
  <header>
    <div class="logo"><span class="glow"></span>LEMO-TUTOR</div>
    <div style="display:flex; gap:12px;">
      <button style="padding:8px 16px; background:transparent; border:1px solid var(--border); border-radius:12px; color:var(--accent); cursor:pointer;" onclick="switchTab('library')">Library</button>
      <button style="padding:8px 16px; background:transparent; border:1px solid var(--border); border-radius:12px; color:var(--accent); cursor:pointer;" onclick="switchTab('chat')">Chat</button>
      <button style="padding:8px 16px; background:transparent; border:1px solid var(--border); border-radius:12px; color:var(--accent); cursor:pointer;" onclick="switchTab('settings')">Settings</button>
    </div>
  </header>

  <div class="main-content">
    <!-- Library tab -->
    <div id="library-tab" class="content-area" style="display:none;">
      <h2>My Library</h2>
      <div style="background:var(--card); padding:20px; border-radius:16px; margin-bottom:24px;">
        <input type="text" id="res-title" placeholder="Resource title" style="margin-bottom:12px;" />
        <input type="file" id="pdf-file" accept=".pdf" style="margin-bottom:12px;" />
        <button class="btn" onclick="uploadPDF()" style="width:100%;">Upload</button>
      </div>
      <div id="library-grid" class="library-grid"></div>
    </div>

    <!-- Chat tab -->
    <div id="chat-tab" class="content-area" style="display:flex; flex-direction:column;">
      <div id="chat-container" style="flex:1;"></div>
      <div class="input-area">
        <div class="input-card">
          <input type="text" id="user-input" placeholder="Ask Lemo anything..." autofocus />
          <button class="send" onclick="sendMessage()">â†’</button>
        </div>
      </div>
    </div>

    <!-- Settings tab -->
    <div id="settings-tab" class="content-area" style="display:none;">
      <h2>Settings</h2>
      <div style="background:var(--card); padding:24px; border-radius:16px;">
        <h3>Groq API Key</h3>
        <input type="password" id="groq-key" placeholder="gsk_..." style="margin:12px 0;" />
        <button class="btn" onclick="saveGroqKey()" style="width:100%;">Save Key</button>
      </div>
    </div>
  </div>
</div>

<script>
  // â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SUPABASE_KEY_NAME = 'lemo_supa_config';
  let supabase = null;
  let user = null;
  let groqKey = null;
  let chatHistory = [{ role:"system", content:"You are Lemo-Tutor, a warm, human engineering tutor living in Rustenburg, South Africa. Speak naturally and conversationally. Never mention being AI. Use proper LaTeX for math." }];

  // â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function init() {
    const saved = localStorage.getItem(SUPABASE_KEY_NAME);
    if (saved) {
      const { url, anon } = JSON.parse(saved);
      supabase = supabase.createClient(url, anon);
      const { data: { session } } = await supabase.auth.getSession();
      if (session) {
        user = session.user;
        await loadGroqKey();
        showMain();
      } else {
        document.getElementById('auth-screen').classList.add('active');
      }
    } else {
      document.getElementById('setup-screen').classList.add('active');
    }
  }

  async function loadGroqKey() {
    const { data } = await supabase.from('user_api_keys').select('groq_key').eq('user_id', user.id).single();
    groqKey = data?.groq_key || null;
  }

  function showMain() {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('main-app').classList.add('active');
    switchTab('chat');
    addAIMessage("Hey! Lemo here from Rustenburg. What's on your mind today?");
  }

  // â”€â”€â”€ SUPABASE SETUP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function saveSupabase() {
    const url = document.getElementById('supa-url').value.trim();
    const anon = document.getElementById('supa-anon').value.trim();
    if (!url || !anon) return alert("Both fields required");
    localStorage.setItem(SUPABASE_KEY_NAME, JSON.stringify({url, anon}));
    location.reload();
  }

  // â”€â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let isSignUp = false;
  function toggleAuth() {
    isSignUp = !isSignUp;
    document.getElementById('auth-title').textContent = isSignUp ? "Create account" : "Welcome back";
    document.querySelector('.btn').textContent = isSignUp ? "Sign Up" : "Sign In";
    document.getElementById('toggle-auth').textContent = isSignUp ? "Already have an account? Sign in" : "Don't have an account? Sign up";
  }

  async function handleAuth() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value.trim();
    if (!email || !password) return alert("Fill both fields");

    let res;
    if (isSignUp) {
      res = await supabase.auth.signUp({ email, password });
    } else {
      res = await supabase.auth.signInWithPassword({ email, password });
    }
    if (res.error) return alert(res.error.message);

    user = res.data.user || res.data.session?.user;
    await loadGroqKey();
    showMain();
  }

  // â”€â”€â”€ TABS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function switchTab(tab) {
    document.getElementById('chat-tab').style.display = tab==='chat' ? 'flex' : 'none';
    document.getElementById('library-tab').style.display = tab==='library' ? 'block' : 'none';
    document.getElementById('settings-tab').style.display = tab==='settings' ? 'block' : 'none';
  }

  // â”€â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function addAIMessage(text) {
    const div = document.createElement('div');
    div.className = 'message ai-msg';
    div.innerHTML = '<span></span><span class="typing-cursor"></span>';
    document.getElementById('chat-container').appendChild(div);

    let i = 0;
    function type() {
      if (i < text.length) {
        div.firstChild.textContent += text[i++];
        div.scrollIntoView({behavior:'smooth'});
        setTimeout(type, 16 + Math.random()*12);
      } else {
        div.removeChild(div.lastChild);
        div.innerHTML = format(text);
        renderMathInElement(div);
      }
    }
    type();
  }

  function format(str) {
    return str
      .replace(/^### ?(.*)$/gm, '<h3>$1</h3>')
      .replace(/^## ?(.*)$/gm,  '<h2>$1</h2>')
      .replace(/^- (.*)$/gm,    '<li>$1</li>')
      .replace(/((<li>.*<\/li>\n*)+)/g, '<ul>$1</ul>')
      .replace(/\n/g, '<br>');
  }

  async function sendMessage() {
    const input = document.getElementById('user-input');
    const text = input.value.trim();
    if (!text) return;

    // show user message
    const userDiv = document.createElement('div');
    userDiv.className = 'message user-msg';
    userDiv.textContent = text;
    document.getElementById('chat-container').appendChild(userDiv);
    input.value = '';

    chatHistory.push({ role:'user', content:text });

    // loading
    const loading = document.createElement('div');
    loading.className = 'message ai-msg';
    loading.innerHTML = 'thinking...';
    document.getElementById('chat-container').appendChild(loading);
    loading.scrollIntoView();

    if (!groqKey) {
      loading.textContent = 'Please add your Groq API key in Settings first.';
      return;
    }

    try {
      const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${groqKey}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          model: 'llama3-70b-8192', // or whichever model you prefer
          messages: chatHistory,
          temperature: 0.7,
          max_tokens: 2048
        })
      });

      const data = await res.json();
      loading.remove();

      if (data.choices?.[0]?.message?.content) {
        const reply = data.choices[0].message.content;
        chatHistory.push({ role:'assistant', content:reply });
        addAIMessage(reply);
      } else {
        addAIMessage("Sorry â€” something went wrong with the API response.");
      }
    } catch (err) {
      loading.remove();
      addAIMessage("Connection error. Check your Groq key or internet.");
    }
  }

  // â”€â”€â”€ PDF UPLOAD (simplified) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function uploadPDF() {
    const title = document.getElementById('res-title').value.trim();
    const file = document.getElementById('pdf-file').files[0];
    if (!title || !file) return alert('Title and file required');

    // This part requires the correct bucket & RLS policy already set
    const path = `${user.id}/${Date.now()}-${file.name}`;
    const { error } = await supabase.storage.from('pdfs').upload(path, file);
    if (error) return alert(error.message);

    const { data: { publicUrl } } = supabase.storage.from('pdfs').getPublicUrl(path);

    await supabase.from('resources').insert({
      user_id: user.id,
      title,
      file_url: publicUrl
    });

    alert('Resource uploaded!');
    document.getElementById('res-title').value = '';
    document.getElementById('pdf-file').value = '';
  }

  // â”€â”€â”€ GROQ KEY SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function saveGroqKey() {
    const key = document.getElementById('groq-key').value.trim();
    if (!key.startsWith('gsk_')) return alert('Groq keys start with gsk_');

    const { error } = await supabase.from('user_api_keys').upsert({
      user_id: user.id,
      groq_key: key
    });

    if (error) return alert(error.message);
    groqKey = key;
    alert('Groq key saved securely!');
  }

  // â”€â”€â”€ START â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('user-input').addEventListener('keypress', e => {
    if (e.key === 'Enter') sendMessage();
  });

  window.onload = init;
</script>
</body>
</html>
