<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEMO-TUTOR</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #05070a; --glass: rgba(15,20,25,0.95); --border: rgba(255,255,255,0.1); --text: #f0f2f5; --cursor-color: #00ffaa; }
        body, html { margin:0; padding:0; width:100%; height:100%; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow:hidden; }
        .app-shell { display:flex; flex-direction:column; height:100dvh; width:100%; max-width:1000px; margin:0 auto; border-left:1px solid var(--border); border-right:1px solid var(--border); }
        header { padding:1.2rem 1.5rem; background:rgba(5,7,10,0.9); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; }
        .logo { font-size:1.1rem; font-weight:700; letter-spacing:3px; color:var(--accent); }
        .glow-dot { width:8px; height:8px; background:var(--accent); border-radius:50%; box-shadow:0 0 12px var(--accent); display:inline-block; margin-right:10px; }
        #chat-container { flex:1; overflow-y:auto; padding:25px; display:flex; flex-direction:column; gap:20px; scroll-behavior:smooth; }
        .message { max-width:85%; padding:16px 20px; border-radius:18px; line-height:1.65; font-size:0.97rem; }
        .user-msg { align-self:flex-end; background:linear-gradient(135deg, rgba(0,255,136,0.1), rgba(0,255,136,0.02)); border:1px solid rgba(0,255,136,0.4); border-bottom-right-radius:4px; }
        .ai-msg { align-self:flex-start; background:var(--glass); border:1px solid var(--border); border-bottom-left-radius:4px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
        .input-area-wrapper { padding:20px; background:linear-gradient(to top, var(--bg) 80%, transparent); }
        .input-card { background:#12171d; border:1px solid var(--border); border-radius:20px; padding:8px 15px; display:flex; align-items:center; gap:12px; }
        input[type="text"] { flex:1; background:transparent; border:none; color:white; padding:12px; font-size:16px; outline:none; }
        .send-btn { background:var(--accent); color:#000; border:none; width:45px; height:45px; border-radius:15px; font-weight:900; cursor:pointer; }
        pre { background:#0a0e14; padding:14px; border-radius:10px; overflow-x:auto; font-family:'JetBrains Mono',monospace; border:1px solid #222; margin:12px 0; }
        h2 { color:#00ffaa; margin:24px 0 12px 0; }
        h3 { color:#00ff99; margin:18px 0 10px 0; }
        ul { padding-left:22px; margin:8px 0; }
        li { margin:6px 0; }
        .typing-cursor { display:inline-block; width:6px; height:1.25em; background:var(--cursor-color); margin-left:4px; border-radius:2px; animation:blink 1s infinite; vertical-align:middle; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
    </style>
</head>
<body>

<div id="lock-screen" style="position:fixed;inset:0;background:#000;z-index:10000;display:flex;align-items:center;justify-content:center;">
    <div class="lock-card" style="width:85%;max-width:350px;padding:40px;background:#0a0a0a;border:1px solid var(--accent);border-radius:30px;text-align:center;">
        <h2 style="color:var(--accent);letter-spacing:5px;">LEMO CORE</h2>
        <input type="password" id="passKey" placeholder="Enter gsk_ key..." style="width:100%;padding:15px;background:#111;border:1px solid #333;color:white;border-radius:12px;margin:20px 0;box-sizing:border-box;">
        <button onclick="unlock()" style="width:100%;padding:15px;background:var(--accent);border:none;font-weight:800;border-radius:12px;cursor:pointer;">UNLOCK</button>
    </div>
</div>

<div class="app-shell">
    <header><div class="logo"><span class="glow-dot"></span>LEMO-TUTOR</div></header>
    <div id="chat-container"></div>
    <div class="input-area-wrapper">
        <div id="preview-box" style="display:none;padding:10px;"></div>
        <div class="input-card">
            <button style="background:transparent;border:none;color:var(--accent);font-size:1.6rem;cursor:pointer;" onclick="document.getElementById('imgInp').click()">ðŸ“Ž</button>
            <input type="file" id="imgInp" accept="image/*" style="display:none" onchange="handleImg()">
            <input type="text" id="userInp" placeholder="Ask me anything..." onkeypress="if(event.key==='Enter') execute()">
            <button class="send-btn" onclick="execute()">â†’</button>
        </div>
    </div>
</div>

<script>
    (function() {
        const greetings = [
            "Hey! Good to see you again. What are we working on today?",
            "Hi! Lemo here from Rustenburg. What's on your mind?",
            "Hello! Memory is all fresh. Ready when you are.",
            "Hey there! How's it going? Got something interesting for us?"
        ];

        const baseSystemPrompt = `You are Lemo-Tutor, a passionate and highly experienced human engineering tutor living in Rustenburg, South Africa. 
You speak naturally, warmly and conversationally like a real top-grade mentor. Use contractions, be encouraging and clear.
Never mention AI, robot, system, database or anything technical about yourself.
You remember every single thing the user has ever said.
Address the user naturally â€” no repeated nicknames.
Format your answers beautifully:
- Use ## for main sections
- ### for subsections
- - for bullet points
- Every equation must be in proper LaTeX: $$ for display math, $ for inline.
Keep explanations accurate, step-by-step when needed, and easy to understand.`;

        let ACTIVE_KEY = localStorage.getItem('L_KEY');
        let imgBase64 = null;
        let chatHistory = [{ role: "system", content: baseSystemPrompt }];

        const lockScreen = document.getElementById('lock-screen');
        const chatContainer = document.getElementById('chat-container');
        const userInp = document.getElementById('userInp');
        const previewBox = document.getElementById('preview-box');

        if (ACTIVE_KEY) {
            lockScreen.style.display = 'none';
            addInitialGreeting();
        }

        function addInitialGreeting() {
            const greeting = greetings[Math.floor(Math.random() * greetings.length)];
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message ai-msg';
            msgDiv.innerHTML = greeting;
            chatContainer.appendChild(msgDiv);
            chatHistory.push({ role: "assistant", content: greeting });
        }

        window.unlock = function() {
            const k = document.getElementById('passKey').value.trim();
            if (k.startsWith('gsk_')) {
                localStorage.setItem('L_KEY', k);
                location.reload();
            } else alert("Invalid key");
        };

        window.handleImg = function() {
            const file = document.getElementById('imgInp').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let w = img.width, h = img.height;
                    if (w > 800) { h = h * 800 / w; w = 800; }
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    imgBase64 = canvas.toDataURL('image/jpeg', 0.7);
                    previewBox.innerHTML = `<img src="${imgBase64}" style="max-height:70px;border-radius:8px;">`;
                    previewBox.style.display = 'block';
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        function parse(text) {
            let html = text
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
                .replace(/^- (.*$)/gm, '<li>$1</li>');

            html = html.replace(/((<li>.*?<\/li>\s*)+)/gs, '<ul>$1</ul>');
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        function typewriterEffect(container, fullText) {
            return new Promise(resolve => {
                container.innerHTML = '';
                const span = document.createElement('span');
                const cursor = document.createElement('span');
                cursor.className = 'typing-cursor';
                container.appendChild(span);
                container.appendChild(cursor);

                let i = 0;
                function type() {
                    if (i < fullText.length) {
                        span.textContent += fullText.charAt(i);
                        i++;
                        setTimeout(type, 20);
                    } else {
                        cursor.remove();
                        const formatted = parse(fullText);
                        const div = document.createElement('div');
                        div.innerHTML = formatted;
                        container.innerHTML = '';
                        container.appendChild(div);
                        renderMathInElement(div, {
                            delimiters: [
                                {left: "$$", right: "$$", display: true},
                                {left: "$", right: "$", display: false}
                            ],
                            throwOnError: false
                        });
                        resolve();
                    }
                }
                type();
            });
        }

        function addMessage(content, isUser = false) {
            const div = document.createElement('div');
            div.className = `message ${isUser ? 'user-msg' : 'ai-msg'}`;
            if (isUser) {
                div.textContent = content;
                chatContainer.appendChild(div);
            } else {
                chatContainer.appendChild(div);
                typewriterEffect(div, content);
            }
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        window.execute = async function() {
            const query = userInp.value.trim();
            if (!query && !imgBase64) return;

            addMessage(query || "Analyzing image...", true);
            userInp.value = '';
            previewBox.style.display = 'none';

            const loading = document.createElement('div');
            loading.className = 'message ai-msg';
            loading.innerHTML = '<span style="opacity:0.6;">thinking...</span>';
            chatContainer.appendChild(loading);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            let userContent = imgBase64 
                ? [{type:"text", text: query || "Please analyze this image"}, {type:"image_url", image_url:{url:imgBase64}}]
                : query;

            chatHistory.push({role:"user", content: userContent});

            try {
                const res = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('L_KEY')}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: "meta-llama/llama-4-scout-17b-16e-instruct",
                        messages: chatHistory,
                        temperature: 0.7,
                        max_tokens: 2048
                    })
                });

                const data = await res.json();
                loading.remove();
                imgBase64 = null;

                if (data.choices) {
                    const reply = data.choices[0].message.content;
                    chatHistory.push({role:"assistant", content: reply});
                    addMessage(reply);
                }
            } catch(e) {
                loading.remove();
                addMessage("Sorry, connection issue. Try again.");
            }
        };

        window.addEventListener('load', () => {
            if (ACTIVE_KEY && chatContainer.children.length === 0) addInitialGreeting();
        });
    })();
</script>
</body>
</html>
