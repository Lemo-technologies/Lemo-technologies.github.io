<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEMO ‚Ä¢ Rustenburg</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.css" crossorigin="anonymous">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.10/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
    <style>
        :root { --accent: #00ff88; --bg: #05070a; --glass: rgba(15,20,25,0.96); --border: rgba(255,255,255,0.08); --text: #f0f2f5; --card: #0f141a; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body, html { height:100%; background:var(--bg); color:var(--text); font-family:'Inter',sans-serif; overflow:hidden; }
        .screen { position:absolute; inset:0; display:none; flex-direction:column; }
        .screen.active { display:flex; }
        header { padding:1rem 1.5rem; background:rgba(5,7,10,0.95); backdrop-filter:blur(20px); border-bottom:1px solid var(--border); display:flex; align-items:center; justify-content:space-between; z-index:100; }
        .logo { font-size:1.3rem; font-weight:700; letter-spacing:3px; color:var(--accent); display:flex; align-items:center; gap:8px; }
        .nav { display:flex; gap:12px; }
        .nav-btn { padding:8px 16px; background:transparent; border:1px solid var(--border); border-radius:12px; color:var(--text); cursor:pointer; font-weight:500; transition:all 0.2s; }
        .nav-btn.active, .nav-btn:hover { background:var(--accent); color:#000; border-color:var(--accent); }
        .auth-card, .setup-card { width:90%; max-width:440px; background:var(--glass); border:1px solid var(--border); border-radius:24px; padding:40px 32px; box-shadow:0 20px 60px rgba(0,0,0,0.5); }
        input { width:100%; padding:14px 18px; background:#0a0e14; border:1px solid var(--border); border-radius:12px; color:white; margin-bottom:16px; font-size:1rem; }
        button.auth-btn { width:100%; padding:14px; background:var(--accent); color:#000; border:none; border-radius:12px; font-weight:700; font-size:1.05rem; cursor:pointer; margin-top:8px; }
        .toggle-link { text-align:center; margin-top:20px; color:var(--accent); cursor:pointer; }
        .main-content { flex:1; display:flex; overflow:hidden; }
        .sidebar { width:260px; background:var(--glass); border-right:1px solid var(--border); padding:20px; display:flex; flex-direction:column; }
        .content-area { flex:1; padding:30px; overflow-y:auto; background:var(--bg); }
        .library-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(240px,1fr)); gap:24px; margin-top:30px; }
        .resource-card { background:var(--card); border:1px solid var(--border); border-radius:16px; overflow:hidden; transition:0.3s; }
        .resource-card:hover { transform:translateY(-8px); box-shadow:0 20px 40px rgba(0,255,136,0.1); }
        .pdf-icon { height:180px; background:linear-gradient(135deg,#1a2330,#0f141a); display:flex; align-items:center; justify-content:center; font-size:4rem; color:#00ff88; }
        .card-body { padding:16px; }
        .card-body h3 { font-size:1.1rem; margin-bottom:8px; line-height:1.3; }
        .card-actions { display:flex; gap:8px; margin-top:12px; }
        .card-actions button { flex:1; padding:8px; border-radius:8px; font-size:0.9rem; }
        #chat-container { flex:1; overflow-y:auto; padding:25px; display:flex; flex-direction:column; gap:20px; scroll-behavior:smooth; }
        .message { max-width:85%; padding:16px 20px; border-radius:18px; line-height:1.65; font-size:0.97rem; }
        .user-msg { align-self:flex-end; background:linear-gradient(135deg, rgba(0,255,136,0.12), rgba(0,255,136,0.03)); border:1px solid rgba(0,255,136,0.4); border-bottom-right-radius:4px; }
        .ai-msg { align-self:flex-start; background:var(--glass); border:1px solid var(--border); border-bottom-left-radius:4px; box-shadow:0 10px 30px rgba(0,0,0,0.3); }
        .input-card { background:#12171d; border:1px solid var(--border); border-radius:20px; padding:8px 15px; display:flex; align-items:center; gap:12px; margin-top:20px; }
        .typing-cursor { display:inline-block; width:6px; height:1.25em; background:var(--accent); margin-left:4px; border-radius:2px; animation:blink 1s infinite; vertical-align:middle; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        pre, code { background:#0a0e14; padding:14px; border-radius:10px; font-family:'JetBrains Mono',monospace; overflow-x:auto; }
    </style>
</head>
<body>

<!-- AUTH SCREEN -->
<div id="auth-screen" class="screen active">
    <div class="auth-card">
        <div class="logo" style="justify-content:center;font-size:2rem;margin-bottom:20px;"><span style="font-size:2.4rem;">üß†</span> LEMO</div>
        <h1 id="auth-title">Welcome back</h1>
        <p id="auth-subtitle">Sign in to continue</p>
        <input type="email" id="email" placeholder="Email address">
        <input type="password" id="password" placeholder="Password">
        <button class="auth-btn" id="auth-btn" onclick="handleAuth()">Sign In</button>
        <div class="toggle-link" id="toggle-link" onclick="toggleAuthMode()">Don't have an account? Register</div>
    </div>
</div>

<!-- SETUP SCREEN (NEW - hides your keys) -->
<div id="setup-screen" class="screen">
    <div class="setup-card">
        <div class="logo" style="justify-content:center;font-size:1.8rem;margin-bottom:30px;">‚öôÔ∏è Supabase Setup</div>
        <p style="text-align:center;opacity:0.8;margin-bottom:24px;">Enter your Supabase details once.<br>They stay only in your browser.</p>
        <input type="text" id="supa-url" placeholder="Supabase URL (e.g. https://abc.supabase.co)">
        <input type="text" id="supa-anon" placeholder="Anon key (starts with eyJ...)">
        <button class="auth-btn" onclick="saveSupabaseConfig()">Save & Continue</button>
        <p style="text-align:center;font-size:0.85rem;margin-top:20px;opacity:0.6;">Your keys are never sent anywhere except to Supabase.</p>
    </div>
</div>

<!-- MAIN APP -->
<div id="main-app" class="screen">
    <header>
        <div class="logo"><span style="display:inline-block;width:10px;height:10px;background:var(--accent);border-radius:50%;box-shadow:0 0 15px var(--accent);"></span> LEMO-TUTOR</div>
        <div class="nav">
            <button class="nav-btn active" onclick="switchView('library')">üìö Library</button>
            <button class="nav-btn" onclick="switchView('chat')">ü§ñ Lemo Tutor</button>
            <button class="nav-btn" onclick="switchView('settings')">‚öôÔ∏è Settings</button>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
            <div id="user-email" style="font-size:0.9rem;opacity:0.8;"></div>
            <button onclick="logout()" style="background:#ff3366;color:white;padding:8px 16px;border:none;border-radius:12px;font-weight:600;cursor:pointer;">Logout</button>
        </div>
    </header>

    <div class="main-content">
        <!-- LIBRARY VIEW -->
        <div id="library-view" class="content-area">
            <h2>My Library ‚Ä¢ Resource Shelves</h2>
            <div style="background:var(--card);padding:24px;border-radius:16px;margin-bottom:30px;">
                <h3 style="margin-bottom:16px;">Upload new resource</h3>
                <input type="text" id="res-title" placeholder="Resource title" style="width:100%;margin-bottom:12px;">
                <input type="file" id="pdf-upload" accept=".pdf" style="margin-bottom:12px;">
                <button onclick="uploadResource()" style="background:var(--accent);color:#000;padding:12px 24px;border:none;border-radius:12px;font-weight:700;cursor:pointer;">Upload to Shelf</button>
            </div>
            <input type="text" id="search" placeholder="Search resources..." onkeyup="filterResources()" style="width:100%;padding:14px;background:var(--card);border:1px solid var(--border);border-radius:12px;margin-bottom:24px;">
            <div id="library-grid" class="library-grid"></div>
        </div>

        <!-- CHAT VIEW -->
        <div id="chat-view" class="content-area" style="display:none;flex-direction:column;">
            <div id="chat-header" style="margin-bottom:20px;">
                <h2>Lemo-Tutor ‚Ä¢ Rustenburg</h2>
                <p style="opacity:0.7;">Your personal engineering tutor.</p>
            </div>
            <div id="chat-container" style="flex:1;"></div>
            <div class="input-card">
                <button onclick="document.getElementById('chat-file').click()" style="background:transparent;border:none;color:var(--accent);font-size:1.6rem;cursor:pointer;">üìé</button>
                <input type="file" id="chat-file" accept="image/*" style="display:none" onchange="handleChatImage()">
                <input type="text" id="chat-input" placeholder="Ask Lemo anything..." style="flex:1;background:transparent;border:none;outline:none;color:white;font-size:16px;" onkeypress="if(event.key==='Enter') sendChatMessage()">
                <button onclick="sendChatMessage()" style="background:var(--accent);color:#000;border:none;width:48px;height:48px;border-radius:14px;font-size:1.4rem;cursor:pointer;">‚Üí</button>
            </div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settings-view" class="content-area" style="display:none;">
            <h2>Account & Settings</h2>
            <div class="setting-card" style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;max-width:620px;">
                <p><strong>Email:</strong> <span id="settings-email"></span></p>
                <br>
                <h3>Groq API Key</h3>
                <input type="password" id="groq-key-input" placeholder="gsk_...">
                <button onclick="saveGroqKey()" style="background:var(--accent);color:#000;padding:12px 28px;border:none;border-radius:12px;font-weight:700;cursor:pointer;margin-top:8px;">Save Groq Key</button>
                <br><br>
                <h3>Supabase Configuration</h3>
                <button onclick="editSupabaseConfig()" style="background:#3366ff;color:white;padding:12px 28px;border:none;border-radius:12px;font-weight:700;cursor:pointer;">Edit Supabase URL & Key</button>
                <p style="margin-top:12px;font-size:0.85rem;opacity:0.7;">Your keys are stored only in your browser.</p>
            </div>
        </div>
    </div>
</div>

<script>
    let supabase;
    let currentUser = null;
    let groqKey = null;
    let resources = [];
    let chatHistory = [];
    let chatImageBase64 = null;
    let supabaseConfig = null;

    // ====================== INIT ======================
    async function init() {
        const savedConfig = localStorage.getItem('lemo_supabase_config');
        if (savedConfig) {
            supabaseConfig = JSON.parse(savedConfig);
            supabase = window.supabase.createClient(supabaseConfig.url, supabaseConfig.anon);
            
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                await loadUserData();
                showMainApp();
            } else {
                document.getElementById("auth-screen").classList.add("active");
            }
        } else {
            document.getElementById("setup-screen").classList.add("active");
        }
    }

    function showMainApp() {
        document.getElementById("auth-screen").classList.remove("active");
        document.getElementById("setup-screen").classList.remove("active");
        document.getElementById("main-app").classList.add("active");
        document.getElementById("user-email").textContent = currentUser.email;
        document.getElementById("settings-email").textContent = currentUser.email;
        
        if (!groqKey) {
            switchView("settings");
        } else {
            switchView("library");
        }
    }

    async function loadUserData() {
        const { data: keyData } = await supabase.from('user_api_keys').select('groq_key').eq('user_id', currentUser.id).single();
        groqKey = keyData?.groq_key || null;

        const { data: resData } = await supabase.from('resources').select('*').eq('user_id', currentUser.id).order('created_at', { ascending: false });
        resources = resData || [];
        renderLibrary();
    }

    // ====================== SETUP (KEYS) ======================
    function saveSupabaseConfig() {
        const url = document.getElementById("supa-url").value.trim();
        const anon = document.getElementById("supa-anon").value.trim();
        if (!url || !anon) return alert("Both fields required");

        localStorage.setItem('lemo_supabase_config', JSON.stringify({url, anon}));
        location.reload(); // restart with config
    }

    function editSupabaseConfig() {
        const config = JSON.parse(localStorage.getItem('lemo_supabase_config') || '{}');
        const newUrl = prompt("Supabase URL", config.url || "");
        const newAnon = prompt("Anon key", config.anon || "");
        if (newUrl && newAnon) {
            localStorage.setItem('lemo_supabase_config', JSON.stringify({url: newUrl, anon: newAnon}));
            alert("Config updated. Refresh the page.");
            location.reload();
        }
    }

    // ====================== AUTH (same as before) ======================
    let isLogin = true;
    function toggleAuthMode() {
        isLogin = !isLogin;
        document.getElementById("auth-title").textContent = isLogin ? "Welcome back" : "Create account";
        document.getElementById("auth-subtitle").textContent = isLogin ? "Sign in to continue" : "Join the engineering community";
        document.getElementById("auth-btn").textContent = isLogin ? "Sign In" : "Create Account";
        document.getElementById("toggle-link").textContent = isLogin ? "Don't have an account? Register" : "Already have an account? Sign in";
    }

    async function handleAuth() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();
        if (!email || !password) return alert("Please fill all fields");

        let res;
        if (isLogin) {
            res = await supabase.auth.signInWithPassword({ email, password });
        } else {
            res = await supabase.auth.signUp({ email, password });
            if (!res.error) {
                alert("Check your email to confirm, then sign in.");
                return;
            }
        }
        if (res.error) return alert(res.error.message);

        currentUser = res.data.user;
        await loadUserData();
        showMainApp();
    }

    async function logout() {
        await supabase.auth.signOut();
        localStorage.removeItem('lemo_supabase_config'); // optional: clear config on logout
        location.reload();
    }

    // ====================== VIEW SWITCH, LIBRARY, CHAT, SETTINGS (same powerful features) ======================
    function switchView(view) { /* ... same as previous version ... */ }
    async function uploadResource() { /* unchanged */ }
    function renderLibrary(filtered = resources) { /* unchanged */ }
    function filterResources() { /* unchanged */ }
    async function deleteResource(id) { /* unchanged */ }
    function initChatUI() { /* unchanged */ }
    async function sendChatMessage() { /* unchanged - uses groqKey */ }
    function handleChatImage() { /* unchanged */ }
    function parseAndRender(text) { /* unchanged */ }
    async function saveGroqKey() { /* unchanged */ }

    // ====================== START ======================
    window.onload = init;
</script>
</body>
</html>
