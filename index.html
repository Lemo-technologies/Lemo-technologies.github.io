<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>LEMO-TUTOR | VISION TERMINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #00ff88; --bg-deep: #05070a; --panel-glass: rgba(18, 22, 28, 0.9); --border: rgba(255, 255, 255, 0.1); --text-main: #e2e8f0; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background-color: var(--bg-deep); color: var(--text-main); font-family: 'Inter', sans-serif; overflow: hidden; }
        .app-shell { display: flex; flex-direction: column; height: 100dvh; width: 100%; max-width: 900px; margin: 0 auto; border-left: 1px solid var(--border); border-right: 1px solid var(--border); background: rgba(10, 14, 20, 0.5); }
        header { padding: 1rem 1.5rem; background: rgba(5, 7, 10, 0.95); backdrop-filter: blur(15px); border-bottom: 1px solid var(--border); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; }
        h1 { margin: 0; font-size: 0.9rem; letter-spacing: 2px; font-weight: 600; color: var(--accent); }
        #chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        .message { max-width: 85%; padding: 14px 18px; border-radius: 14px; font-size: 0.95rem; line-height: 1.6; word-wrap: break-word; animation: slideIn 0.2s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } }
        .user-msg { align-self: flex-end; background: linear-gradient(135deg, rgba(0, 255, 136, 0.1) 0%, rgba(0, 255, 136, 0.02) 100%); border: 1px solid rgba(0, 255, 136, 0.3); color: var(--accent); border-bottom-right-radius: 4px; }
        .ai-msg { align-self: flex-start; background: var(--panel-glass); border: 1px solid var(--border); border-bottom-left-radius: 4px; }
        .input-wrapper { padding: 15px 20px; background: linear-gradient(to top, var(--bg-deep) 70%, transparent); flex-shrink: 0; }
        .input-box { background: #12161c; border: 1px solid var(--border); border-radius: 14px; display: flex; align-items: center; padding: 6px 10px; gap: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); }
        input[type="text"] { flex: 1; background: transparent; border: none; color: white; padding: 12px; font-size: 16px; outline: none; }
        .icon-btn { background: transparent; color: var(--text-main); border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; padding: 5px; }
        .send-btn { background: var(--accent); color: #000; border: none; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-weight: 800; }
        #image-preview { display: none; padding: 10px; border-top: 1px solid var(--border); text-align: left; }
        #image-preview img { max-height: 80px; border-radius: 8px; border: 1px solid var(--accent); }
        pre { background: #000; padding: 12px; border-radius: 8px; overflow-x: auto; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; border: 1px solid #222; }
        #key-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="key-overlay">
    <div style="width: 80%; max-width: 320px; text-align: center; padding: 30px; border: 1px solid var(--accent); border-radius: 20px; background: #0a0a0a;">
        <h2 style="color:var(--accent); font-size: 1rem; letter-spacing: 4px;">SYSTEM LOCK</h2>
        <input type="password" id="keyInput" placeholder="ENTER ACCESS KEY" style="width: 100%; box-sizing: border-box; background: #111; border: 1px solid #333; padding: 12px; color: white; margin: 20px 0; border-radius: 8px;">
        <button onclick="saveKey()" style="width: 100%; height: 45px; background: var(--accent); border:none; font-weight:800; border-radius:10px; cursor:pointer">INITIALIZE</button>
    </div>
</div>

<div class="app-shell">
    <header><h1>LEMO-TUTOR 2.0 <span style="font-size: 0.6rem; opacity: 0.5;">+VISION</span></h1></header>
    <div id="chat-container"><div class="message ai-msg">Vision Terminal Online. Use the attachment icon to upload engineering problems or diagrams.</div></div>
    <div class="input-wrapper">
        <div id="image-preview"></div>
        <div class="input-box">
            <button class="icon-btn" onclick="document.getElementById('fileInput').click()" title="Attach Image">ðŸ“Ž</button>
            <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewImage()">
            <input type="text" id="userInput" placeholder="Ask Lemo-Tutor..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button class="send-btn" onclick="sendMessage()">â†’</button>
        </div>
    </div>
</div>

<script>
    let API_KEY = localStorage.getItem('GROQ_LEMO_KEY');
    let base64Image = null;
    if(API_KEY) document.getElementById('key-overlay').style.display = 'none';

    function saveKey() {
        const val = document.getElementById('keyInput').value.trim();
        if(val.startsWith('gsk_')) { localStorage.setItem('GROQ_LEMO_KEY', val); location.reload(); }
        else { alert("ACCESS DENIED"); }
    }

    function previewImage() {
        const file = document.getElementById('fileInput').files[0];
        const reader = new FileReader();
        reader.onloadend = () => {
            base64Image = reader.result;
            document.getElementById('image-preview').innerHTML = `<img src="${base64Image}">`;
            document.getElementById('image-preview').style.display = 'block';
        };
        if (file) reader.readAsDataURL(file);
    }

    async function sendMessage() {
        const input = document.getElementById('userInput');
        const text = input.value.trim();
        const apiKey = localStorage.getItem('GROQ_LEMO_KEY');
        if (!text && !base64Image) return;

        addMsg(text || "Analyzing image data...", 'user-msg');
        input.value = '';
        document.getElementById('image-preview').style.display = 'none';
        const loadingId = addMsg('<span style="opacity:0.4; font-size:0.8rem">Analyzing Engineering Vector...</span>', 'ai-msg');

        try {
            const bodyContent = {
                model: base64Image ? "llama-3.2-11b-vision-preview" : "llama-3.3-70b-versatile",
                messages: [{
                    role: "user",
                    content: base64Image ? [
                        { type: "text", text: text || "Analyze and solve the engineering problem shown in this image." },
                        { type: "image_url", image_url: { url: base64Image } }
                    ] : text
                }]
            }

            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${apiKey}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(bodyContent)
            });

            const data = await response.json();
            document.getElementById(loadingId).remove();
            base64Image = null;
            
            if(data.choices) addMsg(formatResponse(data.choices[0].message.content), 'ai-msg');
            else addMsg("SYSTEM ERROR: Check Key or Image.", 'ai-msg');
        } catch (e) {
            document.getElementById(loadingId).remove();
            addMsg("CONNECTION LOST.", 'ai-msg');
        }
    }

    function addMsg(html, className) {
        const d = document.createElement('div'); d.className = `message ${className}`; d.innerHTML = html;
        const container = document.getElementById('chat-container'); container.appendChild(d);
        container.scrollTop = container.scrollHeight; return d.id;
    }

    function formatResponse(text) {
        return text.replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
    }
</script>
</body>
</html>
